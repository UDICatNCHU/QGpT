# QGpT 使用指南

## 🎯 概述

QGpT (Question Generation from Partial Tables) 是一個改善表格檢索的框架，通過從部分表格生成合成問題來提升開放域表格檢索的效果。本項目提供完整的表格嵌入向量生成、搜索查詢和評估功能。

## 🏗️ 系統架構

本系統採用模組化設計，包含以下核心組件：

1. **語料庫嵌入向量建立器** (`corpus_embedding_builder.py`)
2. **搜索查詢介面** (`qgpt_search.py`) 
3. **查詢評估器** (`query_evaluator.py`)
4. **公用工具函數** (`utils.py`)
5. **演示程式** (`demo_restructured.py`)

## 📁 檔案結構

```
/Users/yaochungfan/QGpT/
├── corpus_embedding_builder.py # 語料庫嵌入向量建立器
├── qgpt_search.py            # 命令行搜索介面
├── query_evaluator.py        # 查詢評估器
├── demo_restructured.py      # 演示程式
├── example_retrieval.py      # 示例檢索腳本
├── utils.py                  # 公用工具函數
├── qgpt_*.db                # QGpT 向量資料庫檔案
├── requirements.txt         # 依賴套件清單
├── 使用指南.md              # 本檔案（中文使用指南）
├── readme.md                # 英文說明文件
├── CODE_README.md          # 程式碼說明
└── UPDATED_README.md       # 架構更新說明
```

## 🚀 快速開始

### 1. 環境設置

#### 安裝依賴套件
```bash
pip install -r requirements.txt
```

#### 主要依賴
- `pymilvus[model]>=2.3.0` - Milvus 向量資料庫客戶端
- `numpy>=1.21.0` - 數值運算支援

### 2. 運行演示程式

```bash
python demo_restructured.py
```
此演示程式會自動：
- 列出所有可用語料庫
- 建立測試用的嵌入向量
- 執行範例搜索查詢
- 展示系統功能

### 3. 建立語料庫嵌入向量

#### 列出所有可用語料庫
```bash
python corpus_embedding_builder.py --list
```

#### 為單一語料庫建立嵌入向量
```bash
python corpus_embedding_builder.py Corpora/Table1_mimo_table_length_variation/mimo_ch/1k_token.json
```

#### 為所有語料庫建立嵌入向量
```bash
python corpus_embedding_builder.py --all
```

#### 強制重建已存在的資料庫
```bash
python corpus_embedding_builder.py --all --force
```

### 4. 搜索查詢

#### 基本搜索（自動偵測資料庫）
```bash
python qgpt_search.py "財務報表"
```

#### 指定參數的搜索
```bash
# 指定結果數量和格式
python qgpt_search.py "construction project" -n 10 -f json

# 簡單格式輸出
python qgpt_search.py "學生成績" -f simple

# 指定特定資料庫
python qgpt_search.py "銀行利率" --db qgpt_Table1_mimo_ch.db
```

#### 列出所有可用資料庫
```bash
python qgpt_search.py --list-dbs
```

### 5. 查詢評估

#### 單一查詢評估
```bash
python query_evaluator.py "財務報表" --db qgpt_Table1_mimo_ch.db
```

#### 使用測試檔案評估
```bash
python query_evaluator.py --test-file Test_Query_and_GroundTruth_Table/MiMoTable-English_test.json --db qgpt_Table1_mimo_en.db
```

#### 批次評估所有測試集
```bash
python query_evaluator.py --batch-eval
```

## 📊 支援的搜索類型

- **中文查詢**: "財務報表", "建築工程", "學生成績"
- **英文查詢**: "financial statements", "construction project", "student information"
- **混合查詢**: 支援中英文混合的查詢

## 🎛️ 命令行選項

### qgpt_search.py 選項

- `query`: 搜索查詢字符串 (必須)
- `-n, --limit`: 返回結果數量 (預設: 5)
- `-f, --format`: 輸出格式
  - `detailed`: 詳細格式 (預設)
  - `simple`: 簡單格式
  - `json`: JSON 格式
- `--db`: 資料庫路徑 (自動偵測 qgpt_*.db 檔案)
- `--collection`: 集合名稱 (自動從資料庫名稱推導)

### 使用範例

```bash
# 詳細格式搜索
python qgpt_search.py "銀行利率"

# 簡單格式，限制 3 個結果
python qgpt_search.py "bank interest" -n 3 -f simple

# JSON 格式輸出
python qgpt_search.py "教育資源" -f json

# 查看幫助
python qgpt_search.py --help
```

## 🔧 系統架構與工作流程

### 資料庫命名規則

系統會根據語料庫路徑自動生成資料庫和集合名稱：

```
語料庫路徑 → 資料庫名稱
Corpora/Table1_mimo_table_length_variation/mimo_ch/1k_token.json 
→ qgpt_Table1_mimo_table_length_variation_mimo_ch.db

向量集合名稱
Table1_mimo_table_length_variation_mimo_ch 
→ embeddings_Table1_mimo_table_length_variation_mimo_ch
```

### 處理流程

1. **資料載入**: 從 Corpora 目錄載入表格 JSON 資料
2. **結構驗證**: 驗證語料庫資料格式和完整性
3. **文字預處理**: 清理和格式化表格文字
4. **嵌入生成**: 使用預訓練模型生成 768 維向量
5. **向量儲存**: 使用 Milvus 建立向量索引和集合
6. **語義搜索**: 基於向量相似度進行檢索
7. **結果評估**: 支援與 ground truth 比較評估

### 支援的語料庫

系統支援以下實驗語料庫：
- `Table1_mimo_table_length_variation/` - 表格長度變化實驗
- `Table3_mimo_en_table_representation/` - 表格表示方法實驗  
- `Table5_Single_Table_Retrieval/` - 單表檢索實驗
- `Table6_Multi_Table_Retrieval/` - 多表檢索實驗
- `Table7_OTTQA/` - OTTQA 資料集實驗

## 📈 效能指標

- **向量維度**: 768 維（預設，可調整）
- **搜索速度**: 毫秒級響應
- **相似度範圍**: 0.0 - 1.0 (越高越相似)
- **支援語言**: 中文、英文及混合查詢
- **資料庫格式**: Milvus 向量資料庫 (.db 檔案)

## 🛠️ 故障排除

### 常見問題

1. **找不到集合錯誤**
   ```
   錯誤：找不到集合 'qgpt_table_embeddings'
   ```
   解決方案: 先執行 `python corpus_embedding_builder.py` 建立資料庫

2. **編碼錯誤**
   確保終端支援 UTF-8 編碼，特別是在 Windows 系統上

3. **記憶體不足**
   處理大量資料時可能需要更多記憶體，考慮分批處理

### 依賴問題

如果遇到套件相關問題，請確保：
- Python 版本 >= 3.8
- 已安裝所有必要依賴：`pip install -r requirements.txt`

## 📝 相關論文

如果您使用了這個系統，請引用我們的論文：

```bibtex
@inproceedings{
liang2025improving,
title={Improving Table Retrieval with Question Generation from Partial Tables},
author={Hsing-Ping Liang and Che-Wei Chang and Yao-Chung Fan},
booktitle={The 4th Table Representation Learning Workshop at ACL 2025},
year={2025},
url={https://openreview.net/forum?id=Q8HOV0UMwA}
}
```

## 📧 聯絡方式

如有問題或建議，請聯絡：cc3374twa@gmail.com

## � 進階功能

### 批次處理

系統支援批次建立所有語料庫的嵌入向量：
```bash
# 建立所有語料庫（跳過已存在的）
python corpus_embedding_builder.py --all

# 強制重建所有語料庫
python corpus_embedding_builder.py --all --force
```

### 評估功能

#### 單一查詢測試
```bash
python query_evaluator.py "financial data" --db qgpt_Table5_Single_Table_Retrieval_QGpT.db --limit 5
```

#### 批次評估與結果儲存
```bash
# 批次評估並儲存結果
python query_evaluator.py --batch-eval --save

# 指定評估限制數量
python query_evaluator.py --batch-eval --limit 10
```

### 智慧資料庫選擇

搜索時系統會自動：
1. 偵測當前目錄下的所有 .db 檔案
2. 如果只有一個資料庫，自動選擇
3. 如果有多個資料庫，提供選擇清單
4. 支援 `--list-dbs` 查看所有可用資料庫

## �🔄 更新日誌

- **2025/09/09**: 重構程式碼架構，新增模組化設計
  - 新增 `query_evaluator.py` 查詢評估功能
  - 新增 `utils.py` 公用工具模組
  - 改善資料庫命名規範和自動偵測
  - 新增批次處理和評估功能
  - 新增 `demo_restructured.py` 演示程式

- **2025/09/08**: 發布 Hugging Face 資料集
  - 六個測試資料集上線：E2E-WTQ, FeTAQA, MMQA, MimoTable, OTTQA
  - 支援 recall@k 評估

- **初始版本**: 實現基本的表格檢索功能
  - 基礎嵌入向量生成
  - 命令行搜索介面
  - Milvus 向量資料庫整合
